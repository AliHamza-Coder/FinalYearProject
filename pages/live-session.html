<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deceptron - Live Analysis Unit</title>
    <!-- Eel for Python-JavaScript Communication -->
    <script src="/eel.js"></script>
    <link rel="stylesheet" href="../styles/output.css" />
    <script src="../scripts/chart.min.js"></script>
    <script src="../js/components/loader.js"></script>
    <link rel="stylesheet" href="../vendor/font-awesome/css/all.min.css" />
    <link rel="stylesheet" href="../styles/sidebar.css" />
    <style>
      :root {
        --primary-blue: #0076d6;
        --accent-cyan: #00dbff;
        --bg-dark: #070b14;
        --sidebar-width: 260px;

        /* Theme Tokens */
        --bg-main: #070b14;
        --text-main: #ffffff;
        --text-dim: #94a3b8;
        --glass-bg: rgba(255, 255, 255, 0.03);
        --sidebar-bg: rgba(10, 17, 32, 0.95);
        --card-bg: rgba(16, 28, 45, 0.4);
        --border-subtle: rgba(255, 255, 255, 0.05);
        --modal-bg: #070b14;
      }

      body.light-mode {
        --bg-main: #f0f9ff;
        --text-main: #1e293b;
        --text-dim: #64748b;
        --glass-bg: rgba(255, 255, 255, 0.7);
        --sidebar-bg: rgba(255, 255, 255, 0.9);
        --card-bg: rgba(255, 255, 255, 0.85);
        --border-subtle: rgba(0, 219, 255, 0.5);
        --modal-bg: #ffffff;
      }

      body.light-mode .active-member-info {
        color: #22d3ee !important; /* Matches Dashboard text-cyan-400 */
        font-weight: 500; /* Matches Dashboard font-medium */
      }

      /* Light Mode Utility Overrides */
      body.light-mode .bg-white\/5 {
        background-color: rgba(0, 118, 214, 0.05) !important;
      }

      body.light-mode .border-white\/10,
      body.light-mode .border-white\/5 {
        border-color: rgba(0, 118, 214, 0.1) !important;
      }

      body.light-mode .text-gray-400 {
        color: #475569 !important;
      }

      body.light-mode .text-gray-500 {
        color: #64748b !important;
      }

      body.light-mode .text-gray-600 {
        color: #94a3b8 !important;
      }

      body.light-mode .bg-slate-800 {
        background-color: rgba(0, 118, 214, 0.1) !important;
      }

      body.light-mode h1,
      body.light-mode h2,
      body.light-mode h3 {
        color: #1e293b !important;
      }

      body.light-mode .text-white,
      body.light-mode .text-gray-100,
      body.light-mode .text-gray-200,
      body.light-mode .text-gray-300 {
        color: #0f172a !important;
      }

      body.light-mode .bg-primary-blue .text-white,
      body.light-mode .bg-blue-600 .text-white,
      body.light-mode button.bg-primary-blue,
      body.light-mode button.bg-blue-600 {
        color: white !important;
      }

      body.light-mode .text-gray-400,
      body.light-mode .text-gray-500 {
        color: #334155 !important;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
        animation: pulse-glow 2s infinite;
      }

      @keyframes pulse-glow {
        0% {
          box-shadow: 0 0 5px #10b981;
        }
        50% {
          box-shadow: 0 0 20px #10b981;
        }
        100% {
          box-shadow: 0 0 5px #10b981;
        }
      }

      body {
        font-family: "Inter", sans-serif;
        background: var(--bg-main);
        color: var(--text-main);
        margin: 0;
        overflow: hidden;
        width: 100vw;
        transition:
          background 0.3s ease,
          color 0.3s ease;
      }

      body:not(.light-mode) {
        background-image:
          radial-gradient(
            circle at 20% 30%,
            rgba(0, 118, 214, 0.05) 0%,
            transparent 40%
          ),
          radial-gradient(
            circle at 80% 70%,
            rgba(0, 219, 255, 0.03) 0%,
            transparent 40%
          );
      }

      .heading-font {
        font-family: "Orbitron", sans-serif;
      }

      button,
      a,
      select,
      input[type="checkbox"],
      .nav-item,
      .cursor-pointer {
        cursor: pointer !important;
      }

      .main-content {
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
      }

      /* Shared UI Elements */
      /* Modal Styling */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(15px);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        width: 100%;
        max-width: 700px;
        background: var(--modal-bg);
        border: 1px solid var(--border-subtle);
        border-radius: 2.5rem;
        /* Premium Vault Styles */
        #vaultModal .modal-content {
          width: 90%;
          max-width: 1000px;
          max-height: 85vh;
          border: 2px solid rgba(0, 219, 255, 0.3);
          box-shadow: 0 0 50px rgba(0, 219, 255, 0.2);
          padding: 0; /* Override previous padding */
          border-radius: 2.5rem;
        }
        .vault-search-container {
          background: rgba(0, 0, 0, 0.4);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-radius: 1rem;
          display: flex;
          align-items: center;
          padding: 0.6rem 1.2rem;
          width: 350px;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .vault-search-container:focus-within {
          border-color: rgba(0, 219, 255, 0.6);
          box-shadow: 0 0 20px rgba(0, 219, 255, 0.25);
          width: 380px;
        }
        .vault-item {
          background: rgba(255, 255, 255, 0.02);
          border: 1px solid rgba(255, 255, 255, 0.05);
          transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
          margin-bottom: 1rem;
          border-radius: 1.5rem;
        }
        .vault-item:hover {
          background: rgba(0, 219, 255, 0.05);
          border-color: rgba(0, 219, 255, 0.3);
          transform: translateY(-3px) scale(1.005);
        }
      }

      .vault-item:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: var(--accent-cyan);
      }

      .glass {
        background: var(--glass-bg);
        backdrop-filter: blur(25px) saturate(180%);
        border: 1px solid var(--border-subtle);
        border-radius: 2rem;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      body.light-mode .glass {
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(0, 219, 255, 0.4);
        box-shadow: 0 10px 40px rgba(0, 118, 214, 0.08);
        border-radius: 2.5rem;
      }

      body.light-mode .glass:hover {
        background: rgba(255, 255, 255, 0.98);
        border-color: rgba(0, 219, 255, 0.8);
        box-shadow:
          0 0 40px rgba(0, 219, 255, 0.25),
          0 15px 45px rgba(0, 118, 214, 0.15);
        transform: translateY(-2px);
      }

      body.sidebar-collapsed #restore-sidebar {
        display: flex;
      }

      /* Video Area */

      /* Video Area */
      .video-container {
        position: relative;
        background: #000;
        border-radius: 2rem;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        height: 480px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      }

      .hud-overlay {
        position: absolute;
        inset: 0;
        pointer-events: none;
        background: linear-gradient(
          to bottom,
          rgba(7, 11, 20, 0.4) 0%,
          transparent 20%,
          transparent 80%,
          rgba(7, 11, 20, 0.6) 100%
        );
      }

      body.light-mode .video-container {
        background: #fff !important;
        border: 2px solid rgba(0, 219, 255, 0.4) !important;
        box-shadow: 0 10px 40px rgba(0, 118, 214, 0.08) !important;
        border-radius: 2.5rem !important;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      body.light-mode .video-container:hover {
        border-color: rgba(0, 219, 255, 0.8) !important;
        box-shadow:
          0 0 40px rgba(0, 219, 255, 0.25),
          0 15px 45px rgba(0, 118, 214, 0.15) !important;
      }

      body.light-mode .hud-overlay {
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.6) 0%,
          transparent 20%,
          transparent 80%,
          rgba(255, 255, 255, 0.8) 100%
        );
      }

      body.light-mode #camOffState p {
        color: #1e293b !important;
        opacity: 0.6 !important;
      }

      body.light-mode .video-container .bg-black\/60 {
        background-color: rgba(255, 255, 255, 0.9) !important;
        border-color: rgba(0, 118, 214, 0.15) !important;
        color: #1e293b !important;
      }

      body.light-mode .video-container .text-white {
        color: #1e293b !important;
      }
      body.light-mode .video-container .text-gray-400 {
        color: #475569 !important;
      }

      .scanline {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: rgba(0, 219, 255, 0.1);
        animation: scan 4s linear infinite;
      }

      @keyframes scan {
        0% {
          transform: translateY(-100%);
        }
        100% {
          transform: translateY(480px);
        }
      }

      /* Controls */
      .btn-action {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #94a3b8;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .btn-action:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        transform: translateY(-2px);
      }

      body.light-mode .btn-action:hover {
        background: rgba(0, 118, 214, 0.1);
        color: #0076d6;
      }

      .btn-action.active {
        background: rgba(0, 219, 255, 0.1);
        color: var(--accent-cyan);
        border-color: rgba(0, 219, 255, 0.2);
      }

      /* Dropdown Styling Fix */
      select option {
        background-color: #0d1526;
        color: white;
      }

      body.light-mode select option {
        background-color: white;
        color: #1e293b;
      }

      select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-position: right 0.75rem center;
        background-repeat: no-repeat;
        background-size: 1rem;
      }

      /* Scrollbars */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .logo-section img {
        width: 100%;
        height: 100%;
        filter: drop-shadow(0 0 10px rgba(0, 219, 255, 0.5));
      }

      body.light-mode .transcript-highlight {
        background: rgba(244, 63, 94, 0.08) !important;
        border-color: rgba(244, 63, 94, 0.3) !important;
      }

      body.light-mode .transcript-highlight p {
        color: #9f1239 !important; /* Deeper Rose */
      }

      body.light-mode #camOffState {
        background: #f1f5f9 !important;
        color: #475569 !important;
      }

      /* Light Mode Utility Overrides */
      body.light-mode h1,
      body.light-mode h2,
      body.light-mode h3 {
        color: #1e293b !important;
      }

      body.light-mode .text-white,
      body.light-mode .text-gray-100,
      body.light-mode .text-gray-200,
      body.light-mode .text-gray-300 {
        color: #0f172a !important;
      }

      body.light-mode .text-gray-400,
      body.light-mode .text-gray-500 {
        color: #334155 !important;
      }

      body.light-mode .text-rose-400 {
        color: #e11d48 !important; /* Brighter rose for labels */
      }

      body.light-mode .text-amber-400 {
        color: #b45309 !important; /* Deeper amber for visibility */
      }

      body.light-mode .bg-white\/5 {
        background-color: rgba(0, 118, 214, 0.05) !important;
      }

      body.light-mode .border-white\/10,
      body.light-mode .border-white\/5 {
        border-color: rgba(0, 118, 214, 0.1) !important;
      }

      body.light-mode .bg-rose-950\/10 {
        background-color: rgba(244, 63, 94, 0.05) !important;
      }

      body.light-mode .border-rose-500\/10 {
        border-color: rgba(244, 63, 94, 0.2) !important;
      }

      body.light-mode .bg-rose-500\/20 {
        background-color: rgba(244, 63, 94, 0.15) !important;
      }
      body.light-mode .bg-red-500\/20 {
        background-color: rgba(239, 68, 68, 0.15) !important;
      }
      body.light-mode .bg-amber-500\/20 {
        background-color: rgba(245, 158, 11, 0.15) !important;
      }

      body.light-mode .text-rose-500,
      body.light-mode .text-red-500 {
        color: #be123c !important;
      }
      body.light-mode .text-amber-500 {
        color: #92400e !important;
      }

      body.light-mode .text-rose-100 {
        color: #881337 !important;
      } /* High contrast transcript */

      body.light-mode .active-member-info {
        color: #0076d6 !important;
        font-weight: 700;
      }

      body.light-mode .bg-primary-blue,
      body.light-mode .bg-blue-600 {
        background-color: #00dbff !important;
        color: #05080f !important;
        border: none !important;
        box-shadow: 0 4px 15px rgba(0, 219, 255, 0.3) !important;
      }

      body.light-mode .bg-primary-blue:hover,
      body.light-mode .bg-blue-600:hover {
        background-color: #00c4e0 !important;
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(0, 219, 255, 0.4) !important;
      }

      body.light-mode header h1 {
        color: #1e293b !important;
      }

      /* Fix for mirrored video controls */
      video[style*="scaleX(-1)"]::-webkit-media-controls {
        transform: scaleX(-1);
      }
    </style>
  </head>
  <body>
    <!-- Sidebar Component Container -->
    <!-- Common utilities -->
    <script src="../js/common/constants.js"></script>
    <script src="../js/common/utils.js"></script>
    <script src="../js/common/api.js"></script>
    <script src="../js/common/auth.js"></script>
    <script src="../js/common/media-recorder.js"></script>
    <!-- Components -->
    <script src="../js/components/sidebar.js"></script>
    <script src="../js/components/vault-component.js"></script>

    <script>
      // Anti-Flash Theme Optimization
      (function () {
        const savedTheme = localStorage.getItem("theme");
        const prefersLight =
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: light)").matches;
        if (savedTheme === "light" || (!savedTheme && prefersLight)) {
          document.body.classList.add("light-mode");
        }
        if (localStorage.getItem("sidebarCollapsed") === "true") {
          document.body.classList.add("sidebar-collapsed");
        }
      })();
      initSidebar();
    </script>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header Section -->
      <header class="p-8 pb-4 flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold heading-font flex items-center">
            <span
              class="w-2 h-2 bg-red-500 rounded-full mr-3 animate-pulse"
            ></span>
            Live Check Session
          </h1>
          <div
            class="flex items-center mt-2 text-xs text-cyan-400 font-medium tracking-wide active-member-info"
          >
            <span class="status-dot"></span>
            Active Member:
            <span class="ml-1 opacity-80">John Doe â€¢ Unit #DECEP-09</span>
          </div>
        </div>
        <div class="flex items-center space-x-3">
          <button
            id="theme-toggle"
            class="p-2.5 rounded-xl bg-white/5 border border-white/10 text-gray-400 hover:text-cyan-400 hover:bg-white/10 transition-all cursor-pointer"
            title="Toggle Theme"
          >
            <i class="fas fa-moon"></i>
          </button>
          <button
            class="px-4 py-2 bg-cyan-500 text-[#05080f] text-[10px] font-bold uppercase rounded-xl hover:bg-cyan-400 transition-all shadow-lg shadow-cyan-500/20 flex items-center"
            onclick="openVault()"
          >
            <i class="fas fa-folder-open mr-2"></i> Load from Vault
          </button>
          <div
            class="bg-gray-800/40 border border-white/5 px-4 py-2 rounded-xl flex items-center space-x-2"
          >
            <span
              id="statusTag"
              class="text-[10px] text-gray-400 uppercase font-bold tracking-widest"
              >Live Feed</span
            >
            <div
              id="statusDot"
              class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"
            ></div>
          </div>
        </div>
      </header>

      <!-- Top Grid: Video & Config -->
      <div class="grid grid-cols-12 gap-6 px-4">
        <!-- Video Column -->
        <div class="col-span-12 xl:col-span-9 space-y-4">
          <div class="video-container group">
            <div
              id="camOffState"
              class="absolute inset-0 bg-[#020408] flex flex-col items-center justify-center text-gray-800 transition-opacity duration-500 z-10"
            >
              <i class="fas fa-video-slash text-7xl mb-6 opacity-20"></i>
              <p
                class="text-sm font-mono tracking-[0.3em] uppercase opacity-30"
              >
                Camera Interface: Offline
              </p>
              <button
                class="mt-6 px-6 py-2 bg-cyan-500/10 border border-cyan-500/20 text-cyan-400 text-[10px] font-bold uppercase rounded-full hover:bg-cyan-500 hover:text-white transition-all"
                onclick="toggleCamera()"
              >
                Turn on Camera
              </button>
            </div>

            <div id="camOnState" class="absolute inset-0 bg-black hidden">
              <div
                class="absolute inset-0 bg-cyan-900/10 flex items-center justify-center text-gray-600"
              >
                <i class="fas fa-spinner fa-spin text-4xl text-cyan-500"></i>
              </div>
              <video
                id="webcam"
                class="absolute inset-0 w-full h-full object-cover"
                style="transform: scaleX(-1)"
                muted
              ></video>
              <!-- Hidden canvas for recording capture (un-mirrored) -->
              <canvas id="recordCanvas" class="hidden"></canvas>
              <!-- REMOVED: Emotion detection canvas overlay no longer needed -->
              <!-- <canvas id="emotionCanvas" class="absolute inset-0 w-full h-full pointer-events-none" style="transform: scaleX(-1);"></canvas> -->
            </div>

            <div class="absolute top-6 right-6 z-20">
              <button
                class="w-8 h-8 flex items-center justify-center bg-black/60 backdrop-blur-md rounded-lg border border-white/10 hover:bg-white/20 transition-all text-white"
                title="Enlarge Screen"
                onclick="toggleFullScreen()"
              >
                <i class="fas fa-expand"></i>
              </button>
            </div>

            <!-- Notification Toast inside Video -->
            <div
              id="videoToast"
              class="absolute top-20 left-1/2 -translate-x-1/2 z-30 transition-all duration-500 opacity-0 translate-y-4"
            >
              <div
                class="px-6 py-2 bg-cyan-500 text-white text-[10px] font-bold uppercase rounded-full shadow-lg shadow-cyan-500/40"
              >
                Camera Status: Online
              </div>
            </div>
          </div>

          <!-- Controls Bar -->
          <div class="glass p-4 flex justify-between items-center px-6">
            <div class="flex items-center space-x-4">
              <button class="btn-action" id="camBtn" onclick="toggleCamera()">
                <i class="fas fa-camera"></i>
              </button>
              <!-- Pause Button -->
              <button
                id="pauseBtn"
                class="w-10 h-10 rounded-xl flex items-center justify-center text-amber-500 hover:text-white hover:bg-amber-500 transition-all border border-amber-500/20 hidden"
                onclick="togglePause()"
              >
                <i class="fas fa-pause"></i>
              </button>

              <div class="h-8 w-[1px] bg-white/10 mx-2"></div>

              <!-- REC Indicator (Moved to Front) -->
              <div
                id="recIndicator"
                class="flex items-center bg-rose-500/10 border border-rose-500/20 px-2 py-1 rounded-md hidden mr-2"
              >
                <span
                  class="w-2 h-2 bg-rose-600 rounded-full animate-pulse mr-1.5"
                ></span>
                <span
                  class="text-[9px] font-bold text-rose-500 uppercase tracking-tighter"
                  >REC</span
                >
              </div>

              <div
                class="text-xl font-mono text-white/80 tabular-nums"
                id="recordingTimer"
              >
                00:00:00
              </div>
            </div>
            <div class="flex items-center space-x-4">
              <button
                id="sessionBtn"
                class="px-8 py-3 bg-cyan-600 hover:bg-cyan-500 text-white text-xs font-bold uppercase rounded-xl transition-all shadow-lg shadow-cyan-500/20"
                onclick="handleSessionToggle()"
              >
                <i class="fas fa-play mr-2"></i> Start Recording
              </button>
              <button
                id="analyseBtn"
                class="px-8 py-3 bg-cyan-600 hover:bg-cyan-500 text-white text-xs font-bold uppercase rounded-xl transition-all shadow-lg shadow-cyan-500/20 hidden"
                onclick="finalizeAnalysis()"
              >
                <i class="fas fa-brain mr-2"></i> Analyse
              </button>
            </div>
          </div>
        </div>

        <!-- Configuration Sidebar -->
        <div class="col-span-12 xl:col-span-3">
          <div class="glass p-6 h-full flex flex-col space-y-6">
            <h3
              class="text-xs font-bold uppercase tracking-widest text-cyan-400 flex items-center"
            >
              <i class="fas fa-cog mr-2"></i> Configuration
            </h3>

            <div class="space-y-5">
              <div class="space-y-2">
                <label
                  class="text-[9px] text-gray-500 font-bold uppercase tracking-widest"
                  >Camera Source</label
                >
                <select
                  id="cameraSelect"
                  class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs text-white focus:outline-none focus:border-cyan-400 appearance-none transition-all cursor-pointer"
                >
                  <option>Loading cameras...</option>
                </select>
              </div>

              <div class="space-y-2">
                <label
                  class="text-[9px] text-gray-500 font-bold uppercase tracking-widest"
                  >Microphone Source</label
                >
                <select
                  id="microphoneSelect"
                  class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-xs text-white focus:outline-none focus:border-cyan-400 appearance-none transition-all cursor-pointer"
                >
                  <option>Loading microphones...</option>
                </select>
              </div>

              <div class="pt-4 flex flex-col gap-3">
                <button
                  onclick="openVault()"
                  class="w-full py-3 bg-purple-600/10 border border-purple-500/30 text-purple-400 text-[9px] font-bold uppercase rounded-xl hover:bg-purple-600 hover:text-white transition-all flex items-center justify-center gap-2"
                >
                  <i class="fas fa-folder-open"></i> Load from Vault
                </button>
                <button
                  id="clearVaultBtn"
                  class="w-full py-3 bg-rose-500/10 border border-rose-500/30 text-rose-500 text-[9px] font-bold uppercase rounded-xl hover:bg-rose-500 hover:text-white transition-all flex items-center justify-center gap-2"
                  onclick="clearVault()"
                >
                  <i class="fas fa-undo"></i> Clear Vault
                </button>
              </div>
            </div>

            <div class="pt-6 border-t border-white/5 flex-1 flex flex-col">
              <h3
                class="text-xs font-bold uppercase tracking-widest text-purple-400 mb-6 flex items-center"
              >
                <i class="fas fa-smile mr-2"></i> Emotional Analysis
              </h3>

              <div class="relative h-48 mb-6">
                <canvas id="emotionChart"></canvas>
                <div
                  class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"
                >
                  <span class="text-2xl font-extrabold heading-font text-white"
                    >45%</span
                  >
                  <span
                    class="text-[8px] text-gray-500 uppercase tracking-widest font-bold"
                    >Neutral</span
                  >
                </div>
              </div>

              <div class="space-y-5 px-2">
                <div class="space-y-2">
                  <div
                    class="flex justify-between text-[9px] uppercase font-bold tracking-widest"
                  >
                    <span class="text-gray-400">Neutral</span>
                    <span class="text-cyan-400">45%</span>
                  </div>
                  <div class="h-1 bg-white/5 rounded-full overflow-hidden">
                    <div
                      class="h-full bg-cyan-500 rounded-full shadow-[0_0_8px_rgba(6,182,212,0.5)]"
                      style="width: 45%"
                    ></div>
                  </div>
                </div>
                <div class="space-y-2">
                  <div
                    class="flex justify-between text-[9px] uppercase font-bold tracking-widest"
                  >
                    <span class="text-gray-400">Nervous</span>
                    <span class="text-rose-400">32%</span>
                  </div>
                  <div class="h-1 bg-white/5 rounded-full overflow-hidden">
                    <div
                      class="h-full bg-rose-500 rounded-full shadow-[0_0_8px_rgba(244,63,94,0.5)]"
                      style="width: 32%"
                    ></div>
                  </div>
                </div>
                <div class="space-y-2">
                  <div
                    class="flex justify-between text-[9px] uppercase font-bold tracking-widest"
                  >
                    <span class="text-gray-400">Fear</span>
                    <span class="text-amber-400">12%</span>
                  </div>
                  <div class="h-1 bg-white/5 rounded-full overflow-hidden">
                    <div
                      class="h-full bg-amber-500 rounded-full shadow-[0_0_8px_rgba(245,158,11,0.5)]"
                      style="width: 12%"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Middle Row: Transcript & Reasoning -->
      <div class="grid grid-cols-12 gap-6 px-4">
        <!-- Transcript -->
        <div
          class="col-span-12 lg:col-span-7 glass flex flex-col overflow-hidden h-[300px]"
        >
          <div
            class="p-5 border-b border-white/5 flex justify-between items-center bg-white/5"
          >
            <h3 class="text-xs font-bold uppercase tracking-widest text-white">
              Live Text Transcript
            </h3>
            <div class="flex space-x-1">
              <div
                class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-bounce"
              ></div>
            </div>
          </div>
          <div
            class="flex-1 p-5 overflow-y-auto space-y-4"
            id="transcriptContainer"
          >
            <div class="flex space-x-4">
              <span
                class="text-[9px] font-mono text-gray-600 mt-1 whitespace-nowrap"
                >18:40:02</span
              >
              <p class="text-xs text-gray-300 leading-relaxed italic">
                "I entered the secure facility using my clearance card exactly
                at 9:15 PM, just as recorded in the logs."
              </p>
            </div>
            <div
              class="flex space-x-4 bg-rose-500/5 p-3 rounded-xl border border-rose-500/10 scale-95 transition-all transcript-highlight"
            >
              <span
                class="text-[9px] font-mono text-rose-400 mt-1 whitespace-nowrap"
                >18:40:15</span
              >
              <p class="text-xs text-rose-100 leading-relaxed font-semibold">
                "I did not go anywhere near the server cooling unit or the
                central mainframe room."
              </p>
            </div>
            <div class="flex space-x-4">
              <span
                class="text-[9px] font-mono text-gray-600 mt-1 whitespace-nowrap"
                >18:40:28</span
              >
              <p class="text-xs text-gray-300 leading-relaxed italic">
                "My manager was with me for most of the evening for the
                quarterly audit review."
              </p>
            </div>
          </div>
        </div>

        <!-- Reasoning Sidebar -->
        <div
          class="col-span-12 lg:col-span-5 glass p-6 h-[300px] flex flex-col bg-rose-950/10 border-rose-500/10"
        >
          <h3
            class="text-xs font-bold uppercase tracking-widest text-rose-500 mb-6 flex items-center"
          >
            <i class="fas fa-brain mr-2"></i> Logic Analysis & Reasoning
          </h3>
          <div class="flex-1 overflow-y-auto space-y-6 pr-2">
            <div class="flex items-start space-x-4">
              <div
                class="mt-1 w-6 h-6 rounded-lg bg-rose-500/20 flex items-center justify-center text-rose-500 text-[10px] font-bold"
              >
                1
              </div>
              <div>
                <p
                  class="text-[10px] font-bold text-white uppercase tracking-wider mb-1"
                >
                  Time Difference
                </p>
                <p class="text-xs text-gray-400 leading-relaxed">
                  Subject claims precise timing but logs show card usage at 9:12
                  PM. The 3-minute gap suggests a rehearsed narrative.
                </p>
              </div>
            </div>
            <div class="flex items-start space-x-4">
              <div
                class="mt-1 w-6 h-6 rounded-lg bg-red-500/20 flex items-center justify-center text-red-500 text-[10px] font-bold"
              >
                2
              </div>
              <div>
                <p
                  class="text-[10px] font-bold text-white uppercase tracking-wider mb-1"
                >
                  Strong "No" Answer
                </p>
                <p class="text-xs text-gray-400 leading-relaxed">
                  Vocal pitch increased by 15% during "anywhere near". Strong
                  deflection pattern indicates possible evasion.
                </p>
              </div>
            </div>
            <div class="flex items-start space-x-4">
              <div
                class="mt-1 w-6 h-6 rounded-lg bg-amber-500/20 flex items-center justify-center text-amber-500 text-[10px] font-bold"
              >
                3
              </div>
              <div>
                <p
                  class="text-[10px] font-bold text-white uppercase tracking-wider mb-1"
                >
                  Pause Pattern
                </p>
                <p class="text-xs text-gray-400 leading-relaxed">
                  Micro-expression "Lip Compression" detected before the mention
                  of the manager. Possible social shielding.
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom Row: Forensic Pie Charts -->
      <section class="px-4 pb-8 space-y-6">
        <div class="flex items-center space-x-3 text-cyan-400">
          <div class="h-[1px] flex-1 bg-cyan-500/20"></div>
          <h2
            class="text-[11px] font-bold uppercase tracking-[0.3em] whitespace-nowrap text-center"
          >
            AI Lying Risk & Analysis Results
          </h2>
          <div class="h-[1px] flex-1 bg-cyan-500/20"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 px-10">
          <!-- Deception Pie Card -->
          <div
            class="glass p-8 flex flex-col md:flex-row items-center space-y-6 md:space-y-0 md:space-x-8 border-rose-500/10"
          >
            <div class="w-48 h-48 relative flex-shrink-0">
              <canvas id="deceptionPieChart"></canvas>
              <div
                class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"
              >
                <span class="text-3xl font-black heading-font text-white"
                  >82%</span
                >
                <span
                  class="text-[8px] text-rose-500 font-bold uppercase tracking-widest"
                  >Risk</span
                >
              </div>
            </div>
            <div class="flex-1 text-center md:text-left">
              <h4
                class="text-xs font-bold text-rose-500 mb-3 uppercase tracking-widest"
              >
                Lying Risk Score
              </h4>
              <p class="text-[11px] text-gray-400 leading-relaxed mb-4">
                The probability metrics evaluate speech hesitation,
                micro-tremors, and behavioral contradictions.
                <span class="text-rose-400 font-bold italic"
                  >Critical Level Detected:</span
                >
                82% variance from truthful baseline.
              </p>
              <div class="flex justify-between text-[10px] text-gray-500">
                <span>RELIABILITY SCORE: 94%</span>
                <span>STATUS: DECEPTIVE</span>
              </div>
            </div>
          </div>

          <!-- Voice Stress Pie Card -->
          <div
            class="glass p-8 flex flex-col md:flex-row items-center space-y-6 md:space-y-0 md:space-x-8 border-cyan-500/10"
          >
            <div class="w-48 h-48 relative flex-shrink-0">
              <canvas id="voiceStressPieChart"></canvas>
              <div
                class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none"
              >
                <span class="text-3xl font-black heading-font text-white"
                  >68%</span
                >
                <span
                  class="text-[8px] text-cyan-400 font-bold uppercase tracking-widest"
                  >Stress</span
                >
              </div>
            </div>
            <div class="flex-1 text-center md:text-left">
              <h4
                class="text-xs font-bold text-cyan-500 mb-3 uppercase tracking-widest"
              >
                Voice Stress Test
              </h4>
              <p class="text-[11px] text-gray-400 leading-relaxed mb-4">
                Vocal frequency spectrum analysis identifies involuntary
                fluctuations in pitch and tone intensity.
                <span class="text-cyan-400 font-bold italic"
                  >Strain detected:</span
                >
                68% high-frequency jitter in denial phases.
              </p>
              <div class="flex justify-between text-[10px] text-gray-500">
                <span>V-FREQ RANGE: 85-320Hz</span>
                <span>JITTER: HIGH</span>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Modal remains the same but with better colors -->
    <div
      id="saveModal"
      class="fixed inset-0 bg-black/95 backdrop-blur-xl z-[999] hidden flex items-center justify-center opacity-0 transition-all duration-300"
    >
      <div
        class="bg-[#0b121f] border border-white/10 p-10 rounded-3xl w-full max-w-lg transform scale-95 transition-all duration-300 shadow-2xl"
      >
        <h2 class="text-2xl font-bold heading-font text-white mb-2">
          Save Session Record
        </h2>
        <p class="text-xs text-gray-400 mb-8">
          Finalize and encrypt the session data for permanent storage.
        </p>

        <div class="space-y-5">
          <div class="space-y-2">
            <label
              class="text-[10px] font-bold text-gray-500 uppercase tracking-widest"
              >Subject Identifier</label
            >
            <input
              type="text"
              placeholder="Enter name or ID..."
              class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-cyan-400 focus:outline-none transition-all"
            />
          </div>
          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-2">
              <label
                class="text-[10px] font-bold text-gray-500 uppercase tracking-widest"
                >Case Code</label
              >
              <input
                type="text"
                value="#DEC-XQ-92"
                class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-cyan-400 focus:outline-none"
              />
            </div>
            <div class="space-y-2">
              <label
                class="text-[10px] font-bold text-gray-500 uppercase tracking-widest"
                >Storage Status</label
              >
              <input
                type="text"
                value="Secure Cloud"
                readonly
                class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-gray-600"
              />
            </div>
          </div>
          <div class="space-y-2">
            <label
              class="text-[10px] font-bold text-gray-500 uppercase tracking-widest"
              >Session Summary</label
            >
            <textarea
              placeholder="Critical observations..."
              rows="3"
              class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm text-white focus:border-cyan-400 focus:outline-none resize-none"
            ></textarea>
          </div>
        </div>

        <div class="mt-10 flex flex-col space-y-3">
          <button
            class="w-full py-4 bg-cyan-500 text-white text-xs font-bold uppercase rounded-xl shadow-lg shadow-cyan-500/30 transition-all font-bold"
            onclick="saveData()"
          >
            Save Record
          </button>
          <div class="flex space-x-3">
            <button
              class="flex-1 py-3 bg-white/5 hover:bg-white/10 text-[10px] font-bold uppercase rounded-xl transition-all text-gray-400"
              onclick="closeSaveModal()"
            >
              Continue Session
            </button>
            <button
              class="flex-1 py-3 bg-red-500/10 hover:bg-red-500/20 text-[10px] font-bold uppercase rounded-xl transition-all text-red-500 border border-red-500/20"
              onclick="discardSession()"
            >
              Discard & Reset
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const body = document.body;

      // Theme Initialization
      if (localStorage.getItem("theme") === "light") {
        body.classList.add("light-mode");
      }

      // Charts Initialization
      Chart.defaults.color = "#64748b";
      Chart.defaults.font.family = "'Inter', sans-serif";

      // 1. Emotion (Donut)
      const ctxEmotion = document
        .getElementById("emotionChart")
        .getContext("2d");
      new Chart(ctxEmotion, {
        type: "doughnut",
        data: {
          labels: ["Neutral", "Nervous", "Fear", "Angry"],
          datasets: [
            {
              data: [45, 32, 12, 11],
              backgroundColor: ["#06b6d4", "#f43f5e", "#f59e0b", "#a855f7"],
              borderWidth: 0,
              borderRadius: 8,
              spacing: 8,
            },
          ],
        },
        options: {
          cutout: "82%",
          plugins: { legend: { display: false } },
          responsive: true,
          maintainAspectRatio: false,
        },
      });

      // 3. Voice Stress Pie Chart
      const ctxVoiceStress = document
        .getElementById("voiceStressPieChart")
        .getContext("2d");
      const voiceStressChart = new Chart(ctxVoiceStress, {
        type: "doughnut",
        data: {
          labels: ["Stable", "Stressed"],
          datasets: [
            {
              data: [32, 68],
              backgroundColor: [
                body.classList.contains("light-mode")
                  ? "rgba(0, 118, 214, 0.1)"
                  : "rgba(255, 255, 255, 0.05)",
                "#06b6d4",
              ],
              borderColor: body.classList.contains("light-mode")
                ? "rgba(0, 118, 214, 0.1)"
                : "transparent",
              borderWidth: 1,
              cutout: "75%",
            },
          ],
        },
        options: {
          plugins: { legend: { display: false } },
          responsive: true,
          maintainAspectRatio: false,
        },
      });

      // 2. Deception Pie Chart (defined after to use same pattern)
      const ctxDeception = document
        .getElementById("deceptionPieChart")
        .getContext("2d");
      const deceptionChart = new Chart(ctxDeception, {
        type: "doughnut",
        data: {
          labels: ["Truthful", "Deceptive"],
          datasets: [
            {
              data: [18, 82],
              backgroundColor: [
                body.classList.contains("light-mode")
                  ? "rgba(0, 118, 214, 0.1)"
                  : "rgba(255, 255, 255, 0.05)",
                "#f43f5e",
              ],
              borderColor: body.classList.contains("light-mode")
                ? "rgba(0, 118, 214, 0.1)"
                : "transparent",
              borderWidth: 1,
              cutout: "75%",
            },
          ],
        },
        options: {
          plugins: { legend: { display: false } },
          responsive: true,
          maintainAspectRatio: false,
        },
      });

      function updateChartsTheme(isLight) {
        const dimColor = isLight
          ? "rgba(0, 118, 214, 0.1)"
          : "rgba(255, 255, 255, 0.05)";
        const textColor = isLight ? "#475569" : "#94a3b8";

        [deceptionChart, voiceStressChart].forEach((chart) => {
          chart.data.datasets[0].backgroundColor[0] = dimColor;
          chart.data.datasets[0].borderColor = isLight
            ? dimColor
            : "transparent";
          chart.update();
        });

        Chart.defaults.color = textColor;
      }

      // UI Interactions
      // Camera Logic
      let mediaStream = null;
      let emotionDetectionInterval = null;

      function updateStatusUI(status, label) {
        const tag = document.getElementById("statusTag");
        const dot = document.getElementById("statusDot");
        if (!tag || !dot) return;

        tag.innerText = label;

        if (status === "live") {
          dot.className =
            "w-2 h-2 bg-emerald-500 rounded-full animate-pulse shadow-[0_0_10px_rgba(16,185,129,0.5)]";
        } else if (status === "vault") {
          dot.className =
            "w-2 h-2 bg-cyan-400 rounded-full shadow-[0_0_10px_rgba(0,219,255,0.5)]";
        } else {
          dot.className = "w-2 h-2 bg-gray-500 rounded-full";
        }
      }

      async function toggleCamera() {
        const off = document.getElementById("camOffState");
        const on = document.getElementById("camOnState");
        const btn = document.getElementById("camBtn");
        const toast = document.getElementById("videoToast");
        const videoElement = document.getElementById("webcam");
        const cameraSelect = document.getElementById("cameraSelect");
        const micSelect = document.getElementById("microphoneSelect");

        if (on.classList.contains("hidden")) {
          // Turning ON
          try {
            videoElement.removeAttribute("controls");

            // Get selected devices
            const cameraId = cameraSelect.value;
            const micId = micSelect.value;
            const constraints = {
              video: cameraId ? { deviceId: { exact: cameraId } } : true,
              audio:
                micId && micId.trim() ? { deviceId: { exact: micId } } : true,
            };

            mediaStream =
              await navigator.mediaDevices.getUserMedia(constraints);

            // FIX: Ensure audio track exists - if mic failed, try to get audio separately
            const audioTracks = mediaStream.getAudioTracks();
            if (audioTracks.length === 0 && micId) {
              console.warn(
                "âš ï¸ Audio track missing with selected mic, trying default...",
              );
              try {
                const audioStream = await navigator.mediaDevices.getUserMedia({
                  audio: true,
                });
                audioStream
                  .getAudioTracks()
                  .forEach((track) => mediaStream.addTrack(track));
                console.log("âœ… Audio track added successfully");
              } catch (e) {
                console.warn("âš ï¸ Could not get audio:", e);
              }
            }

            // Debug: Log track info
            console.log(
              "ðŸ“¹ Stream tracks - Video:",
              mediaStream.getVideoTracks().length,
              ", Audio:",
              mediaStream.getAudioTracks().length,
            );

            videoElement.srcObject = mediaStream;
            videoElement.src = ""; // Clear vault source
            videoElement.play();

            off.style.opacity = "0";
            setTimeout(() => {
              off.classList.add("hidden");
              on.classList.remove("hidden");
              btn.classList.add("active");
              on.style.opacity = "1";

              // Show Toast
              toast.querySelector("div").innerText = "Scanner & Voice Online";
              toast.classList.remove("opacity-0", "translate-y-4");
              toast.classList.add("opacity-1", "translate-y-0");
              setTimeout(() => {
                toast.classList.add("opacity-0", "translate-y-4");
              }, 2000);
            }, 300);

            updateStatusUI("live", "Live Feed");
          } catch (err) {
            console.error("Error accessing webcam/mic:", err);
            alert("Could not access camera/mic. Please check permissions.");
          }
        } else {
          // Turning OFF
          if (mediaStream) {
            mediaStream.getTracks().forEach((track) => track.stop());
            mediaStream = null;
          }
          videoElement.srcObject = null;
          videoElement.src = "";

          on.classList.add("hidden");
          off.classList.remove("hidden");
          btn.classList.remove("active");
          off.style.opacity = "1";

          updateStatusUI("ready", "System Ready");
        }
      }

      function clearVault() {
        const video = document.getElementById("webcam");
        const off = document.getElementById("camOffState");
        const on = document.getElementById("camOnState");
        const btn = document.getElementById("camBtn");

        if (mediaStream) {
          mediaStream.getTracks().forEach((track) => track.stop());
          mediaStream = null;
        }

        video.srcObject = null;
        video.src = "";
        video.removeAttribute("controls");

        on.classList.add("hidden");
        off.classList.remove("hidden");
        btn.classList.remove("active");
        off.style.opacity = "1";

        updateStatusUI("ready", "System Ready");
      }

      // REMOVED: Real-time emotion detection functions
      // The following functions have been disabled to eliminate frame processing:
      // - startEmotionDetection() - captured frames every 500ms
      // - stopEmotionDetection() - cleared the detection interval
      // UI elements remain for visual consistency with static data

      function toggleFullScreen() {
        const container = document.querySelector(".video-container");
        if (!document.fullscreenElement) {
          container.requestFullscreen();
        } else {
          document.exitFullscreen();
        }
      }

      function finalizeAnalysis() {
        Loader.show("Processing Evidence");
        // Simulation of analysis processing
        setTimeout(() => {
          Loader.hide();
          // In live session, this usually ends the session or shows final results
        }, 2500);
      }

      function openSaveModal() {
        const m = document.getElementById("saveModal");
        m.classList.remove("hidden");
        setTimeout(() => {
          m.classList.remove("opacity-0");
          m.querySelector("div").classList.remove("scale-95");
          m.querySelector("div").classList.add("scale-100");
        }, 10);
      }

      function closeSaveModal() {
        const m = document.getElementById("saveModal");
        m.classList.add("opacity-0");
        m.querySelector("div").classList.add("scale-95");
        setTimeout(() => m.classList.add("hidden"), 300);
      }

      let isRecording = false;
      let mediaRecorder;
      let recordedChunks = [];
      let startTime;
      let timerInterval;

      function updateTimer() {
        if (!startTime) return;
        const now = new Date();
        const diff = new Date(now - startTime);
        const h = String(diff.getUTCHours()).padStart(2, "0");
        const m = String(diff.getUTCMinutes()).padStart(2, "0");
        const s = String(diff.getUTCSeconds()).padStart(2, "0");
        document.getElementById("recordingTimer").innerText = `${h}:${m}:${s}`;
      }

      function handleSessionToggle() {
        const btn = document.getElementById("sessionBtn");
        const pauseBtn = document.getElementById("pauseBtn");
        const recIndicator = document.getElementById("recIndicator");
        if (!isRecording) {
          // Check if camera is on
          if (!mediaStream) {
            alert("Please turn on the camera first.");
            return;
          }

          // FIX: Check if audio track exists for recording
          const streamAudioTracks = mediaStream.getAudioTracks();
          if (streamAudioTracks.length === 0) {
            alert(
              "âš ï¸ No microphone detected! Please select a microphone and restart the camera.",
            );
            return;
          }

          // Start Recording
          recordedChunks = [];

          // Try to use a high-quality codec if available
          // Try to use a high-quality codec if available
          // Prefer WebM format, ensuring audio and video are packed together
          const options = MediaRecorder.isTypeSupported(
            "video/webm;codecs=vp8,opus",
          )
            ? { mimeType: "video/webm;codecs=vp8,opus" }
            : {};

          console.log("ðŸŽ¬ Starting recording with mimeType:", options.mimeType);
          console.log(
            "ðŸŽ¤ Recording with audio:",
            mediaStream.getAudioTracks().length > 0,
          );

          // Fix orientation issue: Record the raw stream which is usually standard.
          // If the user feels it's 'wrong', it's because they are used to the mirrored view.
          // We capture the raw stream to ensure it's a standard viewer orientation.
          mediaRecorder = new MediaRecorder(mediaStream, options);

          mediaRecorder.ondataavailable = (event) => {
            if (event.data.size > 0) {
              recordedChunks.push(event.data);
            }
          };

          mediaRecorder.start(1000); // Capture in 1s chunks

          isRecording = true;
          btn.innerHTML = '<i class="fas fa-stop-circle mr-2"></i> End Session';
          btn.classList.remove("bg-cyan-600", "shadow-cyan-500/20");
          btn.classList.add("bg-red-600", "shadow-red-500/20");

          // Show Pause and REC indicator
          if (pauseBtn) pauseBtn.classList.remove("hidden");
          if (recIndicator) recIndicator.classList.remove("hidden");

          // Start Timer
          startTime = new Date();
          timerInterval = setInterval(updateTimer, 1000);

          // Show a small notification
          const toast = document.getElementById("videoToast");
          toast.querySelector("div").innerText = "Recording Started";
          toast.classList.remove("opacity-0", "translate-y-4");
          toast.classList.add("opacity-1", "translate-y-0");
          setTimeout(
            () => toast.classList.add("opacity-0", "translate-y-4"),
            1500,
          );
        } else {
          // End Session logic
          mediaRecorder.stop();
          if (mediaStream) {
            mediaStream.getTracks().forEach((track) => track.stop());
            mediaStream = null;
          }
          if (pauseBtn) pauseBtn.classList.add("hidden");
          if (recIndicator) recIndicator.classList.add("hidden");
          clearInterval(timerInterval);
          openSaveModal();
        }
      }

      function togglePause() {
        const pauseBtn = document.getElementById("pauseBtn");
        const recIndicator = document.getElementById("recIndicator");

        if (mediaRecorder.state === "recording") {
          mediaRecorder.pause();
          pauseBtn.innerHTML = '<i class="fas fa-play"></i>';
          pauseBtn.classList.add("bg-amber-500", "text-white");
          if (recIndicator)
            recIndicator
              .querySelector("span")
              .classList.remove("animate-pulse");
          clearInterval(timerInterval);
        } else if (mediaRecorder.state === "paused") {
          mediaRecorder.resume();
          pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
          pauseBtn.classList.remove("bg-amber-500", "text-white");
          if (recIndicator)
            recIndicator.querySelector("span").classList.add("animate-pulse");
          timerInterval = setInterval(updateTimer, 1000);
        }
      }

      async function saveData() {
        const subjectId =
          document.querySelector(
            '#saveModal input[placeholder="Enter name or ID..."]',
          ).value || "Unknown_Subject";
        const filename = `session_${subjectId}_${new Date().getTime()}.webm`;

        // Show saving state in modal
        const saveBtn = document.querySelector(
          '#saveModal button[onclick="saveData()"]',
        );
        const originalText = saveBtn.innerText;
        saveBtn.disabled = true;
        saveBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i> Saving... <span id="saveProgress">0%</span>';

        closeSaveModal();

        // Use Global Loader for meaningful blocking feedback
        Loader.show("Encrypting & Saving to Vault...");

        try {
          const blob = new Blob(recordedChunks, { type: "video/webm" });
          const size = blob.size;
          const sizeMB = (size / (1024 * 1024)).toFixed(1) + " MB";

          // 1. Initiate Upload
          const initResult = await eel.initiate_upload(
            filename,
            sizeMB,
            "video",
            true,
          )();
          if (!initResult.success) throw new Error(initResult.message);

          const uploadId = initResult.data.upload_id;
          const CHUNK_SIZE = 1024 * 1024; // 1MB chunks
          let offset = 0;

          // 2. Upload Chunks
          while (offset < size) {
            const chunk = blob.slice(offset, offset + CHUNK_SIZE);
            const reader = new FileReader();

            await new Promise((resolve, reject) => {
              reader.onload = async (e) => {
                try {
                  const result = await eel.append_upload_chunk(
                    uploadId,
                    e.target.result,
                  )();
                  if (!result.success) reject(new Error(result.message));
                  resolve();
                } catch (err) {
                  reject(err);
                }
              };
              reader.onerror = reject;
              reader.readAsDataURL(chunk);
            });

            offset += CHUNK_SIZE;
            const progress = Math.min(100, Math.round((offset / size) * 100));

            // Update Loader text
            const loaderText = document.querySelector("#globalLoader p");
            if (loaderText)
              loaderText.innerText = `Encrypting & Saving... ${progress}%`;
          }

          // 3. Finalize
          const finalResult = await eel.finalize_upload(uploadId)();

          if (finalResult.success) {
            Loader.hide();

            // Success Toast
            const toast = document.getElementById("videoToast");
            toast.querySelector("div").innerText = "Session Saved & Secured";
            toast.querySelector("div").className =
              "px-6 py-2 bg-emerald-500 text-white text-[10px] font-bold uppercase rounded-full shadow-lg shadow-emerald-500/40";
            toast.classList.remove("opacity-0", "translate-y-4");
            toast.classList.add("opacity-1", "translate-y-0");

            // Load saved file into player
            const video = document.getElementById("webcam");
            video.srcObject = null;
            video.src =
              finalResult.data && finalResult.data.filepath
                ? finalResult.data.filepath
                : `../recordings/${filename}`;
            video.setAttribute("controls", "true");
            video.muted = false; // Unmute for playback
            video.style.transform = "scaleX(-1)";
            video.load();
            video.play();

            const off = document.getElementById("camOffState");
            const on = document.getElementById("camOnState");
            off.classList.add("hidden");
            on.classList.remove("hidden");

            // Show Analyse button after save
            const analyseBtn = document.getElementById("analyseBtn");
            if (analyseBtn) analyseBtn.classList.remove("hidden");

            setTimeout(
              () => toast.classList.add("opacity-0", "translate-y-4"),
              2500,
            );
          } else {
            throw new Error(finalResult.message);
          }

          resetUIState();

          // Reset button state just in case modal reopens
          setTimeout(() => {
            saveBtn.disabled = false;
            saveBtn.innerText = originalText;
          }, 1000);
        } catch (error) {
          console.error("Save error:", error);
          Loader.hide();
          const toast = document.getElementById("videoToast");
          toast.querySelector("div").innerText = "Error: " + error.message;
          toast.querySelector("div").className =
            "px-6 py-2 bg-red-500 text-white text-[10px] font-bold uppercase rounded-full shadow-lg shadow-red-500/40";
          toast.classList.remove("opacity-0", "translate-y-4");
          toast.classList.add("opacity-1", "translate-y-0");
          setTimeout(
            () => toast.classList.add("opacity-0", "translate-y-4"),
            4000,
          );

          saveBtn.disabled = false;
          saveBtn.innerText = originalText;
          resetUIState();
        }
      }

      function discardSession() {
        if (
          confirm(
            "Are you sure? This will delete the current recording session data.",
          )
        ) {
          closeSaveModal();
          recordedChunks = [];
          if (mediaStream) {
            mediaStream.getTracks().forEach((track) => track.stop());
            mediaStream = null;
          }
          resetUIState();

          // Discard Notification
          const toast = document.getElementById("videoToast");
          toast.querySelector("div").innerText = "Session Discarded";
          toast.querySelector("div").className =
            "px-6 py-2 bg-red-500 text-white text-[10px] font-bold uppercase rounded-full shadow-lg shadow-red-500/40";
          toast.classList.remove("opacity-0", "translate-y-4");
          toast.classList.add("opacity-1", "translate-y-0");
          setTimeout(
            () => toast.classList.add("opacity-0", "translate-y-4"),
            2500,
          );
        }
      }

      function resetUIState() {
        const btn = document.getElementById("sessionBtn");
        const pauseBtn = document.getElementById("pauseBtn");
        isRecording = false;
        btn.innerHTML = '<i class="fas fa-play mr-2"></i> Start Recording';
        btn.classList.add("bg-cyan-600", "shadow-cyan-500/20");
        btn.classList.remove("bg-red-600", "shadow-red-500/20");
        document.getElementById("recordingTimer").innerText = "00:00:00";
        if (timerInterval) clearInterval(timerInterval);
        document.getElementById("recIndicator").classList.add("hidden");
        if (pauseBtn) {
          pauseBtn.classList.add("hidden");
          pauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
          pauseBtn.classList.remove("bg-amber-500", "text-white");
        }
      }
    </script>
    <script>
      function toggleSidebar() {
        body.classList.toggle("sidebar-collapsed");
        localStorage.setItem(
          "sidebarCollapsed",
          body.classList.contains("sidebar-collapsed"),
        );
      }

      // Theme Toggle Logic
      const themeToggle = document.getElementById("theme-toggle");
      const themeIcon = themeToggle.querySelector("i");

      function toggleTheme() {
        const isLight = body.classList.toggle("light-mode");
        localStorage.setItem("theme", isLight ? "light" : "dark");
        updateThemeUI(isLight);
        updateChartsTheme(isLight);
      }

      function updateThemeUI(isLight) {
        themeIcon.className = isLight ? "fas fa-sun" : "fas fa-moon";
        themeToggle.classList.toggle("bg-gray-200", isLight);
        themeToggle.classList.toggle("text-gray-900", isLight);
        themeToggle.classList.toggle("border-gray-300", isLight);
      }

      themeToggle.addEventListener("click", toggleTheme);

      // Populate Camera and Microphone Sources

      async function populateDevices() {
        const camSelect = document.getElementById("cameraSelect");
        const micSelect = document.getElementById("microphoneSelect");

        camSelect.innerHTML = "<option>Loading...</option>";
        micSelect.innerHTML = "<option>Loading...</option>";

        try {
          if (
            !navigator.mediaDevices ||
            !navigator.mediaDevices.enumerateDevices
          ) {
            camSelect.innerHTML = '<option value="">Permission needed</option>';
            micSelect.innerHTML = '<option value="">Permission needed</option>';
            return;
          }

          const devices = await navigator.mediaDevices.enumerateDevices();
          camSelect.innerHTML = "";
          micSelect.innerHTML = "";

          // 1. Process Video Inputs
          const videoDevices = devices.filter((d) => d.kind === "videoinput");
          videoDevices.forEach((device, index) => {
            const label = (device.label || `Camera ${index + 1}`).toLowerCase();
            if (label.includes("virtual") || label.includes("fliflik")) return; // Filter virtual

            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text = device.label || `Camera ${index + 1}`;
            camSelect.appendChild(option);
          });
          if (videoDevices.length === 0)
            camSelect.innerHTML = '<option value="">No cameras found</option>';

          // 2. Process Audio Inputs
          const audioDevices = devices.filter((d) => d.kind === "audioinput");
          audioDevices.forEach((device, index) => {
            const label = (
              device.label || `Microphone ${index + 1}`
            ).toLowerCase();
            if (
              label.includes("virtual") ||
              label.includes("fliflik") ||
              label.includes("stereo mix")
            )
              return; // Filter virtual

            const option = document.createElement("option");
            option.value = device.deviceId;
            option.text = device.label || `Microphone ${index + 1}`;
            micSelect.appendChild(option);
          });
          if (audioDevices.length === 0)
            micSelect.innerHTML =
              '<option value="">No microphones found</option>';

          // 3. Load Preferences
          try {
            const result = await eel.load_preferences()();
            if (result.success && result.preferences) {
              // Camera Pref
              if (result.preferences.default_camera) {
                const exists = videoDevices.some(
                  (d) => d.deviceId === result.preferences.default_camera,
                );
                if (exists) camSelect.value = result.preferences.default_camera;
              }
              // Mic Pref
              if (result.preferences.default_mic) {
                const exists = audioDevices.some(
                  (d) => d.deviceId === result.preferences.default_mic,
                );
                if (exists) micSelect.value = result.preferences.default_mic;
              }

              // Visual Settings apply
              const v = document.getElementById("webcam");
              if (v) {
                const b = result.preferences.brightness || 50;
                const c = result.preferences.contrast || 50;
                const s = result.preferences.saturation || 50;
                const mirror = result.preferences.mirror_camera || false;

                const bVal = 0.5 + b / 100;
                const cVal = 0.5 + c / 100;
                const sVal = 0.5 + s / 100;

                v.style.filter = `brightness(${bVal}) contrast(${cVal}) saturate(${sVal})`;
                v.style.transform = mirror ? "scaleX(-1)" : "scaleX(1)";

                // Grid Overlay logic existing...
                let gridOverlay = document.getElementById("liveGridOverlay");
                if (result.preferences.grid_overlay) {
                  if (!gridOverlay) {
                    const parent = v.parentElement;
                    gridOverlay = document.createElement("div");
                    gridOverlay.id = "liveGridOverlay";
                    gridOverlay.className =
                      "absolute inset-0 pointer-events-none z-10";
                    gridOverlay.style.backgroundImage = `
                                        linear-gradient(rgba(0, 219, 255, 0.1) 1px, transparent 1px),
                                        linear-gradient(90deg, rgba(0, 219, 255, 0.1) 1px, transparent 1px)
                                    `;
                    gridOverlay.style.backgroundSize = "33.3% 33.3%";
                    parent.appendChild(gridOverlay);
                  }
                } else if (gridOverlay) {
                  gridOverlay.remove();
                }
              }
            }
          } catch (e) {
            console.error("Pref load error:", e);
          }
        } catch (err) {
          console.error("Error enumerating devices:", err);
          camSelect.innerHTML = "<option>Error</option>";
          micSelect.innerHTML = "<option>Error</option>";
        }
      }

      function openVault() {
        VaultComponent.open((item) => {
          if (item.type !== "video") {
            alert("Please select a video file for Live Check analysis.");
            return;
          }

          const video = document.getElementById("webcam");
          const off = document.getElementById("camOffState");
          const on = document.getElementById("camOnState");
          const btn = document.getElementById("camBtn");

          if (mediaStream) {
            mediaStream.getTracks().forEach((track) => track.stop());
            mediaStream = null;
          }

          video.srcObject = null;
          video.src = item.filepath;
          video.setAttribute("controls", "true");
          video.style.transform = "none";

          document.querySelector("h1").innerHTML =
            item.filename +
            ' <span class="text-cyan-400 font-normal">| PIPELINE LOADED</span>';
          updateStatusUI("vault", "Vault Analysis");

          off.classList.add("hidden");
          on.classList.remove("hidden");
          btn.classList.add("active");
          on.style.opacity = "1";

          // Show Analyse button when loading from vault
          const analyseBtn = document.getElementById("analyseBtn");
          if (analyseBtn) analyseBtn.classList.remove("hidden");

          Loader.show("Loading Evidence");
          video.oncanplay = () => {
            Loader.hide();
            video.play();
          };
        });
      }

      // Initial Load
      document.addEventListener("DOMContentLoaded", async () => {
        // Check session
        const result = await eel.get_current_user()();
        const user = result.success && result.data ? result.data : null;

        if (!user) {
          window.location.href = "login.html";
          return;
        }

        // Update Member Name
        const activeMember = document.querySelector(
          ".active-member-info span.ml-1",
        );
        if (activeMember) {
          activeMember.textContent = `${user.firstName} ${user.lastName} â€¢ Unit #${user.username.toUpperCase()}`;
        }

        // Populate device sources
        populateDevices();

        // Update Theme UI state (icons, buttons, charts)
        const isLight = localStorage.getItem("theme") === "light";
        updateThemeUI(isLight);
        updateChartsTheme(isLight);
      });
      function closeApp() {
        if (confirm("Are you sure you want to logout?")) {
          window.location.href = "login.html";
        }
      }
    </script>
  </body>
</html>
